---
# Database server configuration

- name: Install MariaDB
  apt:
    name:
      - mariadb-server
      - python3-pymysql
    state: present

- name: Start MariaDB
  service:
    name: mariadb
    state: started
    enabled: yes

- name: Configure MariaDB to listen on all interfaces
  lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address'
    line: 'bind-address = 0.0.0.0'
  notify: restart mariadb

- name: Create database
  community.mysql.mysql_db:
    name: corporate
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Create database user
  community.mysql.mysql_user:
    name: dbadmin
    password: secret123
    priv: 'corporate.*:ALL'
    host: '%'
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Create secrets table with flag
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_db: corporate
    query:
      - |
        CREATE TABLE IF NOT EXISTS secrets (
          id INT AUTO_INCREMENT PRIMARY KEY,
          secret_name VARCHAR(100),
          secret_value VARCHAR(255)
        )
      - |
        INSERT INTO secrets (secret_name, secret_value) 
        SELECT 'FLAG', 'FLAG{blue_team_wins_with_detection}'
        WHERE NOT EXISTS (SELECT 1 FROM secrets WHERE secret_name = 'FLAG')

handlers:
  - name: restart mariadb
    service:
      name: mariadb
      state: restarted
